# 代码分析目录

本目录包含海思视频应用代码库的综合分析和重构文档。

## 目录内容

### 主要文档

- **[ANALYSIS.md](./ANALYSIS.md)**: 当前代码库的综合分析
  - RTSP 模块架构和功能
  - RTMP 模块架构和功能
  - 设备模块架构和功能
  - 当前系统限制
  - 多摄像头支持分析
  - 提议的架构设计
  - 详细的重构需求

- **[REFACTORING_ROADMAP.md](./REFACTORING_ROADMAP.md)**: 详细的重构计划
  - 16 周的实施时间表
  - 分阶段细分
  - 优先级行动事项
  - 代码示例和片段
  - 成功指标
  - 风险缓解策略

### 子目录

#### `rtsp/`
重构的 RTSP 模块代码的占位目录。将包含：
- 流路由实现
- 流实例管理
- 增强的 URL 解析
- 动态流注册

**状态：** 未填充（等待重构）

#### `rtmp/`
重构的 RTMP 模块代码的占位目录。将包含：
- 多会话改进
- URL 模板支持
- 增强的错误处理
- H.265 支持研究

**状态：** 未填充（等待重构）

#### `device/`
重构的设备模块代码的占位目录。将包含：
- 摄像头管理器实现
- 摄像头实例抽象
- 资源管理器
- 多摄像头支持

**状态：** 未填充（等待重构）

## 关键发现

### 当前状态
- **仅单摄像头**：MAX_CHANNEL = 1 硬编码
- **静态配置**：基于 JSON 文件，需要重启
- **固定流 URL**：仅支持 stream1、stream2、stream3
- **紧耦合**：Channel 类管理过多职责

### 目标状态
- **多摄像头支持**：同时支持 2-4 个摄像头
- **动态配置**：运行时创建摄像头/流
- **灵活的 URL**：/camera/{id}/{stream} 方案
- **模块化设计**：通过插件系统分离关注点

## 架构图

### 当前架构
```
应用程序（单摄像头）
    ↓
  chn（通道）
    ├─ VI（传感器）
    ├─ VPSS（处理）
    ├─ VENC（编码）
    └─ 特性（OSD、AIISP 等）
    ↓
流分发（观察者模式）
    ├─ RTSP 服务器
    ├─ RTMP 会话
    ├─ MP4 录制
    └─ JPEG 快照
```

### 提议的架构
```
应用程序管理器
    ↓
摄像头管理器
    ├─ 摄像头实例 0
    │   ├─ VI/VPSS/VENC
    │   └─ 流实例 []
    ├─ 摄像头实例 1
    │   ├─ VI/VPSS/VENC
    │   └─ 流实例 []
    └─ 摄像头实例 N
        ├─ VI/VPSS/VENC
        └─ 流实例 []
    ↓
流路由器
    ↓
服务层
    ├─ RTSP 服务
    ├─ RTMP 服务
    └─ 录制服务
```

## 关键重构要点

### 1. 移除 MAX_CHANNEL 限制
**优先级：** 高  
**工作量：** 中  
**影响：** 启用多摄像头支持

```cpp
// 之前
#define MAX_CHANNEL 1
static std::shared_ptr<chn> g_chns[MAX_CHANNEL];

// 之后
// 通过 camera_manager 动态分配
```

### 2. 实现摄像头管理器
**优先级：** 高  
**工作量：** 高  
**影响：** 多摄像头的核心抽象

### 3. 流路由器
**优先级：** 高  
**工作量：** 中  
**影响：** 灵活的 URL 映射和流分发

### 4. 资源管理器
**优先级：** 高  
**工作量：** 高  
**影响：** 防止资源耗尽，验证配置

### 5. 配置系统
**优先级：** 中  
**工作量：** 高  
**影响：** 统一的多摄像头配置

### 6. 特性插件系统
**优先级：** 中  
**工作量：** 高  
**影响：** 模块化的单摄像头特性控制

## 实施阶段

### 阶段 1：基础（第 1-4 周）
- 资源管理器
- 摄像头管理器
- 流路由器
- **目标：** 核心抽象，无破坏性更改

### 阶段 2：多摄像头（第 5-8 周）
- 移除 MAX_CHANNEL 限制
- 双摄像头配置
- 多 VENC 捕获
- **目标：** 2+ 摄像头同时工作

### 阶段 3：高级特性（第 9-12 周）
- 特性插件系统
- 动态重新配置
- RESTful API（可选）
- **目标：** 生产就绪特性

### 阶段 4：优化（第 13-16 周）
- 性能分析
- 代码优化
- 压力测试
- **目标：** 生产强化

## 测试策略

### 单元测试
- 资源分配/释放
- 摄像头生命周期管理
- 流路由逻辑
- 配置验证

### 集成测试
- 单摄像头（回归测试）
- 双摄像头
- 四摄像头最大值
- 所有特性组合

### 性能测试
- CPU 使用率（目标：<80%）
- 内存使用（目标：<512MB）
- 帧率稳定性（每个摄像头 30fps）
- 延迟（RTSP <100ms）

### 压力测试
- 7 天连续运行
- 最大 RTSP 客户端
- 网络中断
- 资源耗尽

## 成功指标

### 功能性
- ✅ 同时支持 2-4 个摄像头
- ✅ 独立的摄像头配置
- ✅ 动态流创建/删除
- ✅ 多摄像头 RTSP URL
- ✅ 多摄像头 RTMP 支持

### 性能
- ✅ 每个摄像头 30fps（1080p）
- ✅ RTSP 延迟 <100ms
- ✅ CPU 使用率 <80%（四核）
- ✅ 内存 <512MB
- ✅ 99.9% 正常运行时间

### 质量
- ✅ 零严重错误
- ✅ <0.1% 丢帧率
- ✅ 自动恢复
- ✅ 完整的文档
- ✅ 全面的测试

## 使用指南

### 开发者
1. 阅读 `ANALYSIS.md` 以全面了解
2. 查看 `REFACTORING_ROADMAP.md` 了解实施计划
3. 遵循分阶段实施
4. 为每个组件编写测试
5. 边做边更新文档

### 审查者
1. 检查架构是否与 ANALYSIS.md 一致
2. 验证重构是否遵循 ROADMAP 优先级
3. 确保保持向后兼容性
4. 审查测试覆盖率
5. 验证性能目标

## 依赖项

### 硬件
- 海思 3519DV500 芯片
- 多个摄像头传感器（OS04A10、OS08A20）
- 开发板

### 软件
- 海思 MPP SDK V2.0.2.1
- C++17 编译器
- librtmp
- jsoncpp
- log4cpp

## 相关文档

### 仓库内
- `/README.md`：主项目 README
- `/doc/set.md`：配置指南
- `/doc/debug_log.md`：调试信息

### 外部
- 海思 MPP SDK 文档
- RTSP RFC 2326
- RTP RFC 3984 (H.264)
- RTMP 规范

## 贡献指南

在贡献重构代码时：

1. **放置在适当的子目录**
   - `cn_analyst/rtsp/` 用于 RTSP 重构
   - `cn_analyst/rtmp/` 用于 RTMP 重构
   - `cn_analyst/device/` 用于设备重构

2. **遵循编码标准**
   - C++17 风格
   - 一致的命名约定
   - 全面的注释
   - 需要单元测试

3. **更新文档**
   - 如架构更改则更新 ANALYSIS.md
   - 更新 ROADMAP.md 进度
   - 文档化新 API

4. **全面测试**
   - 新代码的单元测试
   - 交互的集成测试
   - 性能基准测试

## 联系方式

关于此分析的问题：
- 查看问题跟踪器
- 检查现有文档
- 咨询团队负责人

## 版本历史

- **v1.0**（2026-01-04）：初始分析和路线图
  - 完整的架构分析
  - 详细的重构计划
  - 多摄像头设计

## 许可证

与主项目相同。

---

**注意：** 本目录包含分析和规划文档。实际重构代码将在实施开始后放置在子目录中。
